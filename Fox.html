<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quantum Fox: Endless Runner</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/23.1.1/tween.umd.js"></script>
<style>
body { margin:0; overflow:hidden; background:#0d1117; color:#f3f4f6; font-family:Inter,system-ui,Arial; }
canvas { display:block; }
#ui-container{ position:absolute; top:0; left:0; right:0; padding:10px 20px; z-index:10; display:flex; justify-content:space-between; align-items:center; pointer-events:none; }
.info-box{ background: rgba(0,0,0,0.7); padding:8px 16px; border-radius:8px; font-size:1.1rem; font-weight:700; border:2px solid #3b82f6; min-width:140px; text-align:center; }
#touch-indicator{ position:absolute; bottom:20px; left:50%; transform:translateX(-50%); z-index:10; background: rgba(0,0,0,0.7); padding:8px 14px; border-radius:8px; color:#fcd34d; border:2px solid #3b82f6; pointer-events:none; font-weight:700; }
#game-over-screen, #leaderboard-screen{ position:absolute; inset:0; display:none; z-index:30; align-items:center; justify-content:center; background: rgba(0,0,0,0.9); color:#f3f4f6; flex-direction:column; opacity:0; transition:opacity .4s; text-align:center; overflow-y:auto; padding:20px; }
.button-group { display:flex; gap:15px; margin-top:20px; pointer-events:auto; }
.restart-button, .close-button{ padding:12px 22px; border-radius:.5rem; font-weight:800; border:none; cursor:pointer; background:#fcd34d; color:#111827; transition: all 0.2s; }
.restart-button:hover, .close-button:hover { background:#fbbf24; transform:translateY(-2px); }
#initials-form { display:none; flex-direction:column; align-items:center; margin:20px 0; background: rgba(255,255,255,0.1); padding:20px; border-radius:12px; border:2px solid #fcd34d; animation: pulse-border 2s infinite; }
@keyframes pulse-border { 0% { border-color:#fcd34d; box-shadow:0 0 0 0 rgba(252,211,77,0.4); } 70% { border-color:#fcd34d; box-shadow:0 0 0 10px rgba(252,211,77,0); } 100% { border-color:#fcd34d; box-shadow:0 0 0 0 rgba(252,211,77,0); } }
#initials-input { background:#111827; border:2px solid #4b5563; color:#10b981; font-size:3rem; text-align:center; width:180px; border-radius:8px; text-transform:uppercase; margin-bottom:15px; font-family:monospace; letter-spacing:0.2em; }
#initials-input:focus { outline:none; border-color:#10b981; }
#submit-score-btn { background:#10b981; color:#064e3b; padding:10px 30px; border-radius:6px; font-weight:800; border:none; cursor:pointer; font-size:1.2rem; transition:all 0.2s; }
#submit-score-btn:disabled { background:#4b5563; cursor:not-allowed; transform:none; }
#leaderboard-content { width:90%; max-width:600px; margin-top:20px; background:rgba(0,0,0,0.7); border-radius:10px; padding:20px; border:2px solid #10b981; max-height:60vh; overflow-y:auto; }
.leaderboard-entry { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #374151; font-size:1.1rem; }
.leaderboard-entry:last-child { border-bottom:none; }
.leaderboard-entry.header { font-weight:800; font-size:1.3rem; color:#fcd34d; border-bottom:2px solid #fcd34d; margin-bottom:10px; }
.leaderboard-entry .rank { width:10%; text-align:center; color:#10b981; }
.leaderboard-entry .initials { width:30%; text-align:left; }
.leaderboard-entry .score { width:30%; text-align:right; }
</style>
</head>
<body>
<div id="ui-container">
    <div id="score-display" class="info-box">Score: 0</div>
    <div id="high-score-display" class="info-box">High Score: 0</div>
    <div class="info-box text-sm">Tap Left / Right to Switch Lanes</div>
</div>
<div id="touch-indicator">Tap Left / Right Side</div>
<div id="game-container"></div>
<div id="game-over-screen">
    <h2 style="font-size:3.25rem; color:#ef4444; margin:0 0 .6rem 0; font-weight:900;">Game  Over</h2>
    <p style="font-size:1.25rem; margin:0 0 1rem 0;">Final Distance Run: <span id="final-score" style="color:#fbbf24; font-weight:800;">0</span></p>
    <div id="initials-form">
        <p style="font-size:1.2rem; color:#fcd34d; font-weight:800; margin-bottom:10px;">NEW HIGH SCORE!</p>
        <input type="text" id="initials-input" maxlength="3" placeholder="___" autocomplete="off">
        <button id="submit-score-btn">SUBMIT</button>
    </div>
    <div class="button-group">
        <button id="restart-btn" class="restart-button">RESTART</button>
        <button id="leaderboard-btn" class="restart-button">LEADERBOARD</button>
    </div>
    <p style="margin-top:12px; color:#9ca3af; font-size:0.9rem;">User ID: <span id="user-id-display">Anonymous</span></p>
</div>
<div id="leaderboard-screen">
    <button id="close-leaderboard" class="close-button" style="position:absolute; top:20px; right:20px; padding:8px 16px; font-size:1.1rem;">âœ• CLOSE</button>
    <h2 style="font-size:3rem; color:#10b981; margin-bottom:20px; font-weight:900;">TOP 100 RUNNERS</h2>
    <div id="leaderboard-content">
        <div class="leaderboard-entry header">
            <span class="rank">#</span>
            <span class="initials">INITIALS</span>
            <span class="score">SCORE</span>
        </div>
        <div id="leaderboard-list">Loading...</div>
    </div>
</div>
<script type="module">
/* --- FIREBASE SETUP OMITTED (keep same as your code) --- */

/* --- GAME ASSETS --- */
const FOX_HEAD_URL = 'head.png';
const OBSTACLE_URL = 'orb.png';
const FLOOR_IMAGE_URL= 'floor.png';
const BACKGROUND_VIDEO_URL = 'background.mp4';
const MUSIC_URL = 'music.wav';

let bgm = null;
function initializeMusic() {
    bgm = new Audio(MUSIC_URL);
    bgm.loop = true;
    bgm.volume = 0.7;
}

/* --- GLOBALS --- */
let scene, camera, renderer;
let foxPlayer = null;
let floorTexture = null;
let floorMesh = null;
let score = 0;
let gameActive = false;
let lanePositions = [-3.5, 0, 3.5];
let currentLane = 1;
let obstacles = [];
let obstacleSpawnTimer = 0;
let gameSpeed = 0.25;
const BASE_GAME_SPEED = 0.25;
const SPEED_INCREASE_RATE = 0.0006;
let runningTime = 0;
const FOX_BASE_HEIGHT = 1.2;
let lastTime = performance.now();
const TARGET_FPS = 60;
const FRAME_TIME = 1000 / TARGET_FPS;
const container = document.getElementById('game-container');

const textureLoader = new THREE.TextureLoader();

/* --- VIDEO BACKGROUND --- */
function setupVideoBackground(){
    if (!scene) return;
    try {
        const vid = document.createElement('video');
        vid.src = BACKGROUND_VIDEO_URL;
        vid.loop = true; vid.muted = true; vid.playsInline = true;
        vid.play().catch(()=>{});
        const vtex = new THREE.VideoTexture(vid);
        vtex.minFilter = THREE.LinearFilter; vtex.magFilter = THREE.LinearFilter;
        scene.background = vtex;
    } catch (e) { console.warn('Video background failed:', e); }
}

/* --- FOX --- */
function createFox(){
    const geo = new THREE.PlaneGeometry(1.8,1.8);
    const mat = new THREE.MeshBasicMaterial({color:0xff00ff, transparent:true});
    foxPlayer = new THREE.Mesh(geo, mat);
    textureLoader.load(FOX_HEAD_URL, tex=>{
        tex.encoding = THREE.sRGBEncoding;
        foxPlayer.material = new THREE.MeshBasicMaterial({map:tex, transparent:true, side:THREE.FrontSide});
        foxPlayer.material.needsUpdate = true;
    });
    foxPlayer.position.set(lanePositions[currentLane], FOX_BASE_HEIGHT, 5);
    scene.add(foxPlayer);
}

/* --- TRACK --- */
function createTrack(){
    const trackWidth = 18, trackLength=600;
    const floorGeo = new THREE.PlaneGeometry(trackWidth, trackLength,1,1);
    const tex = textureLoader.load(FLOOR_IMAGE_URL, t=>{
        t.wrapS = t.wrapT = THREE.RepeatWrapping;
        t.repeat.set(4,60);
        t.encoding = THREE.sRGBEncoding;
    });
    const floorMat = new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide});
    floorMesh = new THREE.Mesh(floorGeo, floorMat);
    floorMesh.rotation.x = -Math.PI/2;
    floorMesh.position.set(0,0,0);
    scene.add(floorMesh);
    floorTexture = tex;
}

/* --- OBSTACLES --- */
function createObstacle(laneIndex){
    if (!scene) return;
    const laneX = lanePositions[laneIndex];
    const startZ = -120;
    const geo = new THREE.SphereGeometry(0.9,16,16);
    const mat = new THREE.MeshBasicMaterial({color:0xffffff});
    const orb = new THREE.Mesh(geo, mat);
    orb.position.set(laneX, 1.35, startZ);
    orb.userData.lane = laneIndex;
    obstacles.push(orb);
    textureLoader.load(OBSTACLE_URL, tex=>{
        tex.encoding=THREE.sRGBEncoding;
        orb.material.map = tex;
        orb.material.needsUpdate = true;
    });
    scene.add(orb);
}

/* --- GAME CONTROL --- */
function startGame(){
    if (!scene || !renderer || !camera) init();
    if (bgm && bgm.paused) bgm.play().catch(()=>{});
    gameActive = true; score=0; gameSpeed=BASE_GAME_SPEED; currentLane=1;
    if (foxPlayer) foxPlayer.position.x = lanePositions[currentLane];
    obstacles.forEach(o=>scene.remove(o));
    obstacles=[]; obstacleSpawnTimer=0;
    document.getElementById('score-display').textContent = `Score: ${score}`;
    document.getElementById('game-over-screen').style.display='none';
    document.getElementById('game-over-screen').style.opacity=0;
    document.getElementById('leaderboard-screen').style.display='none';
    document.getElementById('initials-form').style.display='none';
}

function moveFox(newLane){
    if (!gameActive) { startGame(); return; }
    if (!foxPlayer) return;
    if (newLane<0 || newLane>2 || newLane===currentLane) return;
    currentLane=newLane;
    const targetX=lanePositions[currentLane];
    TWEEN.removeAll();
    new TWEEN.Tween(foxPlayer.position).to({x:targetX},150).easing(TWEEN.Easing.Quadratic.Out).start();
}

function updateObstacles(deltaMultiplier){
    gameSpeed += SPEED_INCREASE_RATE * deltaMultiplier;
    for (let i=obstacles.length-1;i>=0;i--){
        const obs=obstacles[i];
        obs.position.z += gameSpeed * deltaMultiplier;
        const foxZ = foxPlayer.position.z;
        const obsZ = obs.position.z;
        if (obsZ>=foxZ-0.9 && obsZ<=foxZ+0.9 && obs.userData.lane===currentLane){
            doGameOver(); return;
        }
        if (obsZ>foxZ+2 && !obs.userData.scored){ obs.userData.scored=true; score+=10; document.getElementById('score-display').textContent=`Score: ${score}`; }
        if (obsZ>80){ scene.remove(obs); obstacles.splice(i,1); }
    }
    obstacleSpawnTimer++;
    const spawnRate=Math.max(18,70-Math.floor((gameSpeed-BASE_GAME_SPEED)*140));
    if (obstacleSpawnTimer>=spawnRate){ createObstacle(Math.floor(Math.random()*3)); obstacleSpawnTimer=0; }
}

function doGameOver(){
    if (!gameActive) return;
    gameActive=false; if (bgm) bgm.pause();
    document.getElementById('final-score').textContent = score;
    document.getElementById('game-over-screen').style.display='flex';
    if (typeof window.handleGameOver==='function') window.handleGameOver(score);
    new TWEEN.Tween({o:0}).to({o:1},450).onUpdate(obj=>{document.getElementById('game-over-screen').style.opacity=obj.o;}).start();
}

/* --- INPUT --- */
function onKeyDown(e){ if (e.target.tagName==='INPUT') return; if (e.code==='KeyA'||e.code==='ArrowLeft') moveFox(currentLane-1); if (e.code==='KeyD'||e.code==='ArrowRight') moveFox(currentLane+1);}
function onTouchStart(e){ if (!e.touches||e.touches.length===0) return; const x=e.touches[0].clientX; if (x<window.innerWidth/2) moveFox(currentLane-1); else moveFox(currentLane+1);}

/* --- INIT + ANIMATE --- */
let hasInited=false;
function init(){
    if (hasInited) return; hasInited=true;
    scene=new THREE.Scene();
    scene.fog=new THREE.Fog(new THREE.Color('#111827'),40,150);
    setupVideoBackground();
    camera=new THREE.PerspectiveCamera(72, window.innerWidth/window.innerHeight,0.1,1000);
    camera.position.set(0,3.5,10); camera.lookAt(0,1,0);
    renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth,window.innerHeight);
    container.appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0xffffff,20));
    const spot = new THREE.SpotLight(0xffffff,20,50,Math.PI/6,0.3); spot.position.set(0,10,10); scene.add(spot);
    createFox(); createTrack();
    window.addEventListener('keydown',onKeyDown,false);
    window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight);},false);
    document.addEventListener('touchstart',onTouchStart,{passive:true});
    document.getElementById('restart-btn').addEventListener('click',()=>startGame());
    document.getElementById('leaderboard-btn').addEventListener('click',()=>window.showLeaderboard());
    document.getElementById('close-leaderboard').addEventListener('click',()=>{const lb=document.getElementById('leaderboard-screen'); lb.style.opacity=0; setTimeout(()=>lb.style.display='none',300);});
}

function animate(){
    requestAnimationFrame(animate);
    const currentTime = performance.now();
    const deltaTime = currentTime - lastTime;
    lastTime = currentTime;
    const deltaMultiplier = deltaTime / FRAME_TIME;
    TWEEN.update();
    if (gameActive){
        updateObstacles(deltaMultiplier);
        runningTime += 0.11 * deltaMultiplier;
        if (foxPlayer) foxPlayer.position.y = FOX_BASE_HEIGHT + Math.sin(runningTime*5)*0.1;
        if (floorTexture) floorTexture.offset.y += gameSpeed*0.02*deltaMultiplier;
    }
    renderer.render(scene,camera);
}

window.addEventListener('load',()=>{
    initializeMusic();
    init();
    animate();
});
</script>
</body>
</html>
