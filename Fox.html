<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Fox: Endless Runner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/23.1.1/tween.umd.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #0d1117; color: #f3f4f6; font-family: 'Inter', sans-serif; }
        canvas { display: block; }

        #ui-container {
            position: absolute; top: 0; left: 0; right: 0; padding: 10px 20px; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: none;
        }
        .info-box {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 1.25rem;
            font-weight: 700;
            border: 2px solid #3b82f6;
            min-width: 150px;
            text-align: center;
        }

        #game-over-screen, #leaderboard-screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            color: #f3f4f6;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.5s;
        }
        #leaderboard-screen {
            overflow-y: auto;
            padding: 20px;
        }
        #leaderboard-content {
            width: 90%;
            max-width: 600px;
            margin-top: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #10b981;
        }
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #374151;
            font-size: 1.1rem;
        }
        .leaderboard-entry:last-child { border-bottom: none; }
        .leaderboard-entry.header {
            font-weight: 800;
            font-size: 1.3rem;
            color: #fcd34d;
            border-bottom: 2px solid #fcd34d;
            margin-bottom: 10px;
        }
        .leaderboard-entry .initials { width: 30%; text-align: left; }
        .leaderboard-entry .score { width: 30%; text-align: right; }
        .leaderboard-entry .rank { width: 10%; text-align: center; color: #10b981; }

        /* Press to Start Message Style */
        #start-message {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 5rem; 
            font-weight: 900;
            color: #f3f4f6;
            opacity: 0.1; /* Transparent letters */
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 15;
            text-transform: uppercase;
        }
        #start-message.hidden {
            display: none;
        }
        
        #touch-indicator {
            position: absolute;
            bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #fcd34d;
            border: 2px solid #3b82f6;
            z-index: 10;
            pointer-events: none;
        }

        /* Button Group for Game Over Screen */
        .button-group {
            display: flex;
            gap: 20px; 
            margin-top: 20px;
        }
        .restart-button, .close-button {
            padding: 12px 24px;
            background-color: #fcd34d;
            color: #1f2937;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.3rem;
            font-weight: 800;
            transition: background-color 0.2s, transform 0.1s;
            pointer-events: auto;
        }
        .restart-button:hover, .close-button:hover {
            background-color: #fbbf24;
            transform: translateY(-2px);
        }

        /* NEW: Initials Input Form Styles */
        #initials-form {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #fcd34d;
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { border-color: #fcd34d; box-shadow: 0 0 0 0 rgba(252, 211, 77, 0.4); }
            70% { border-color: #fcd34d; box-shadow: 0 0 0 10px rgba(252, 211, 77, 0); }
            100% { border-color: #fcd34d; box-shadow: 0 0 0 0 rgba(252, 211, 77, 0); }
        }
        #initials-input {
            background: #111827;
            border: 2px solid #4b5563;
            color: #10b981;
            font-size: 3rem;
            text-align: center;
            width: 180px;
            border-radius: 8px;
            text-transform: uppercase;
            margin-bottom: 15px;
            font-family: monospace;
            letter-spacing: 0.2em;
        }
        #initials-input:focus {
            outline: none;
            border-color: #10b981;
        }
        #submit-score-btn {
            background: #10b981;
            color: #064e3b;
            padding: 10px 30px;
            border-radius: 6px;
            font-weight: 800;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        #submit-score-btn:hover { background: #34d399; transform: scale(1.05); }
        #submit-score-btn:disabled { background: #4b5563; cursor: not-allowed; transform: none; }
    </style>
</head>
<body>

<div id="ui-container">
    <div id="score-display" class="info-box">Score: 0</div>
    <div id="high-score-display" class="info-box">High Score: 0</div>
</div>

<div id="touch-indicator">Swipe Left / Right to Switch Lanes</div>

<div id="game-container"></div>

<div id="start-message">PRESS TO START</div>

<div id="game-over-screen">
    <h2 class="text-6xl font-extrabold text-red-500 mb-4">STATE COLLAPSE</h2>
    <p class="text-2xl mb-2">Final Distance Run: <span id="final-score" class="text-yellow-400 font-bold">0</span></p>
    
    <!-- NEW: Initials Input Form -->
    <div id="initials-form">
        <p class="text-xl text-yellow-300 font-bold mb-3 uppercase tracking-wider">New High Score!</p>
        <input type="text" id="initials-input" maxlength="3" placeholder="___" autocomplete="off">
        <button id="submit-score-btn">SUBMIT</button>
    </div>

    <div class="button-group">
        <button class="restart-button" onclick="startGame()">RESTART</button>
        <button class="restart-button" onclick="window.showLeaderboard()">LEADERBOARD</button>
    </div>
    
    <p class="text-lg mt-6 text-gray-500 font-mono text-sm">User ID: <span id="user-id-display">Loading...</span></p>
</div>

<div id="leaderboard-screen">
    <h2 class="text-5xl font-extrabold text-green-400 mb-4">TOP 1000 RUNNERS</h2>
    <div id="leaderboard-content">
        <div class="leaderboard-entry header">
            <span class="rank">#</span>
            <span class="initials">INITIALS</span>
            <span class="score">SCORE</span>
        </div>
        <div id="leaderboard-list">Loading...</div>
    </div>
    <button class="close-button" onclick="document.getElementById('leaderboard-screen').style.display = 'none';">CLOSE</button>
</div>

<script type="module">
/* -------------------------------------------------
   FIREBASE CONFIGURATION & LOGIC (V9 Modular)
---------------------------------------------------*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, addDoc, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const HIGH_SCORE_KEY = 'quantumFoxHighScore';
let db, auth, user;
let isFirebaseReady = false;
window.highScoreValue = 0;
window.qfoxUserId = 'Anonymous';

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
let firebaseConfig = null;
try {
    firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
} catch (e) { console.error("Failed to parse __firebase_config as JSON:", e); }
let initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Initialize Firebase
async function initFirebase() {
    try {
        if (!firebaseConfig) {
            console.error("Firebase config missing. High scores disabled.");
            return;
        }

        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (currentUser) => {
            if (currentUser) {
                user = currentUser;
                window.qfoxUserId = user.uid;
                isFirebaseReady = true;
                loadHighScore();
            } else {
                isFirebaseReady = false;
            }
        });

    } catch (error) {
        console.error("Error initializing Firebase:", error);
    }
}

async function loadHighScore() {
    try {
        const localScore = localStorage.getItem(HIGH_SCORE_KEY);
        if (localScore !== null) {
            window.highScoreValue = parseInt(localScore, 10) || 0;
            document.getElementById('high-score-display').textContent = `High Score: ${window.highScoreValue}`;
        }
    } catch (e) { console.warn("localStorage issue:", e); }

    if (!isFirebaseReady || !user) return;

    try {
        const scoreDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_data', 'high_score_doc');
        const docSnap = await getDoc(scoreDocRef);
        if (docSnap.exists()) {
            const firebaseScore = docSnap.data().score || 0;
            if (firebaseScore > window.highScoreValue) {
                window.highScoreValue = firebaseScore;
                document.getElementById('high-score-display').textContent = `High Score: ${window.highScoreValue}`;
                try { localStorage.setItem(HIGH_SCORE_KEY, window.highScoreValue.toString()); } catch (e) {}
            }
        }
    } catch (error) { console.error("Error loading score:", error); }
}

// --- NEW LOGIC: Separated Handling ---

// 1. Check and Save Personal Best (Always runs on Game Over)
window.handleGameOver = async function(finalScore) {
    // Check Personal High Score
    if (finalScore > window.highScoreValue) {
        window.highScoreValue = finalScore;
        document.getElementById('high-score-display').textContent = `High Score: ${window.highScoreValue}`;
        
        try { localStorage.setItem(HIGH_SCORE_KEY, finalScore.toString()); } catch (e) {}

        if (isFirebaseReady && user) {
            try {
                const scoreDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_data', 'high_score_doc');
                // Fire and forget - don't await this blocking UI
                setDoc(scoreDocRef, { score: finalScore, timestamp: serverTimestamp() }, { merge: true });
            } catch (e) { console.error("Save error:", e); }
        }
    }

    // Check Global Qualification
    const form = document.getElementById('initials-form');
    form.style.display = 'none'; // Ensure hidden initially

    if (isFirebaseReady && user) {
        try {
            const leaderboardRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            const lowScoreQuery = query(leaderboardRef, orderBy('score', 'desc'), limit(1000));
            const querySnapshot = await getDocs(lowScoreQuery);
            
            let lowestTopScore = 0;
            if (!querySnapshot.empty) {
                const docs = querySnapshot.docs;
                lowestTopScore = docs[docs.length - 1].data().score || 0;
            }

            // If we beat the lowest score OR the leaderboard isn't full yet
            if (finalScore > lowestTopScore || querySnapshot.size < 1000) {
                showInitialsInput(finalScore);
            }
        } catch (error) {
            console.error("Leaderboard check failed:", error);
        }
    }
}

// 2. Show UI for Initials
function showInitialsInput(score) {
    const form = document.getElementById('initials-form');
    const input = document.getElementById('initials-input');
    const btn = document.getElementById('submit-score-btn');
    
    form.style.display = 'flex';
    input.value = '';
    input.focus();
    btn.textContent = "SUBMIT";
    btn.disabled = false;
    
    // Store score in dataset to retrieve on submit
    form.dataset.score = score;
}

// 3. Submit Handler
document.getElementById('submit-score-btn').addEventListener('click', async () => {
    const form = document.getElementById('initials-form');
    const input = document.getElementById('initials-input');
    const btn = document.getElementById('submit-score-btn');
    
    let initials = input.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 3);
    if (!initials) initials = "AAA";
    
    const score = parseInt(form.dataset.score);

    btn.textContent = "SAVING...";
    btn.disabled = true;

    if (isFirebaseReady && user) {
        try {
            const leaderboardRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            await addDoc(leaderboardRef, {
                score: score,
                initials: initials,
                uid: user.uid,
                timestamp: serverTimestamp()
            });
            
            btn.textContent = "SAVED!";
            setTimeout(() => {
                form.style.display = 'none';
                window.showLeaderboard(); // Auto-show leaderboard to confirm
            }, 800);
            
        } catch (e) {
            console.error("Submit error:", e);
            btn.textContent = "ERROR";
            setTimeout(() => { btn.disabled = false; btn.textContent = "RETRY"; }, 2000);
        }
    }
});

// Input helper: Auto-capitalize and limit
document.getElementById('initials-input').addEventListener('input', (e) => {
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 3);
});


// 4. Leaderboard Display Logic (Unchanged mostly)
window.showLeaderboard = async function() {
    if (window.gameActive) return; 
    
    const screen = document.getElementById('leaderboard-screen');
    const list = document.getElementById('leaderboard-list');
    
    screen.style.display = 'flex';
    screen.style.opacity = 1; 
    list.innerHTML = '<div style="text-align:center; padding: 20px;">Loading leaderboard...</div>';

    if (!isFirebaseReady) {
        list.innerHTML = 'Service unavailable.';
        return;
    }

    try {
        const leaderboardRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
        const q = query(leaderboardRef, orderBy('score', 'desc'), limit(100)); // Limit 100 for display speed
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            list.innerHTML = 'Be the first to post a score!';
            return;
        }

        let html = '';
        snapshot.docs.forEach((doc, index) => {
            const data = doc.data();
            const rank = index + 1;
            const initials = data.initials || '???';
            const score = data.score || 0;

            // Highlight current user
            const isMe = (user && data.uid === user.uid) ? 'color: #fcd34d; font-weight:bold;' : '';

            html += `
                <div class="leaderboard-entry" style="${isMe}">
                    <span class="rank">${rank}</span>
                    <span class="initials">${initials}</span>
                    <span class="score">${score.toLocaleString()}</span>
                </div>
            `;
        });

        list.innerHTML = html;

    } catch (error) {
        console.error("Error fetching leaderboard:", error);
        list.innerHTML = 'Error loading data.';
    }
}

initFirebase();
</script>

<script>
/* -------------------------------------------------
   ASSET PATHS
---------------------------------------------------*/
const FOX_HEAD_URL = "head.png";
const OBSTACLE_URL = "orb.png";
const FLOOR_IMAGE_URL = "floor.png";
const BACKGROUND_VIDEO_URL = "background.mp4";

/* -------------------------------------------------
   MUSIC
---------------------------------------------------*/
let bgm = null;
function initializeMusic() {
    bgm = new Audio("music.wav");
    bgm.loop = true;
    bgm.volume = 0.7;

    const unlock = () => {
        bgm.play().catch(()=>{});
        document.removeEventListener("keydown", unlock);
        document.removeEventListener("touchstart", unlock);
    };

    document.addEventListener("keydown", unlock);
    document.addEventListener("touchstart", unlock);
}

/* -------------------------------------------------
   GLOBALS (Game Logic)
---------------------------------------------------*/
let scene, camera, renderer;
let foxPlayer;
let floorTexture = null;

let score = 0;
window.gameActive = false; 

const lanePositions = [-2.5, 0, 2.5];
let currentLane = 1;

let obstacles = [];
let obstacleSpawnTimer = 0;

let gameSpeed = 0.2;
const BASE_GAME_SPEED = 0.2;
const SPEED_INCREASE_RATE = 0.0005;

let runningTime = 0;
const FOX_BASE_HEIGHT = 1.2;

let touchStartX = 0;
let touchStartY = 0;
const SWIPE_THRESHOLD = 50;

const container = document.getElementById("game-container");
const scoreDisplay = document.getElementById("score-display");
const gameOverScreen = document.getElementById("game-over-screen");
const startMessage = document.getElementById("start-message");

const textureLoader = new THREE.TextureLoader();

/* -------------------------------------------------
   BACKGROUND VIDEO
---------------------------------------------------*/
function setupVideoBackground() {
    const video = document.createElement("video");
    video.src = BACKGROUND_VIDEO_URL;
    video.loop = true;
    video.muted = true;
    video.playsInline = true;

    video.play().catch(() => {
        scene.background = new THREE.Color(0x0d1117);
    });

    const videoTexture = new THREE.VideoTexture(video);
    videoTexture.minFilter = THREE.LinearFilter;
    videoTexture.magFilter = THREE.LinearFilter;
    scene.background = videoTexture;
}

/* -------------------------------------------------
   FOX, TRACK, OBSTACLES
---------------------------------------------------*/
function createFox() {
    const geo = new THREE.PlaneGeometry(1.5, 1.5);
    let mat = new THREE.MeshBasicMaterial({ color: 0xff00ff });

    foxPlayer = new THREE.Mesh(geo, mat);

    textureLoader.load(FOX_HEAD_URL, tex => {
        foxPlayer.material = new THREE.MeshBasicMaterial({
            map: tex,
            transparent: true,
            side: THREE.FrontSide
        });
    });

    foxPlayer.position.set(lanePositions[currentLane], FOX_BASE_HEIGHT, 5);
    scene.add(foxPlayer);
}

function createTrack() {
    const trackWidth = 12;
    const trackLength = 400;

    const floorGeo = new THREE.PlaneGeometry(trackWidth, trackLength);

    const tex = textureLoader.load(FLOOR_IMAGE_URL, t => {
        t.wrapS = THREE.RepeatWrapping;
        t.wrapT = THREE.RepeatWrapping;
        t.repeat.set(1, 20);
    });

    const floorMat = new THREE.MeshBasicMaterial({
        map: tex,
        side: THREE.DoubleSide
    });

    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.position.z = -trackLength / 3;

    scene.add(floor);
    floorTexture = tex;
}

function createObstacle(laneIndex) {
    const obsWidth = 2;
    const obsHeight = 2;
    const geo = new THREE.PlaneGeometry(obsWidth, obsHeight);

    let mat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });

    const obs = new THREE.Mesh(geo, mat);
    obs.position.set(lanePositions[laneIndex], 1.2, -60);
    obs.userData.lane = laneIndex;

    textureLoader.load(OBSTACLE_URL, tex => {
        obs.material = new THREE.MeshBasicMaterial({
            map: tex,
            transparent: true,
            side: THREE.DoubleSide
        });
        obs.material.needsUpdate = true;
    });

    obstacles.push(obs);
    scene.add(obs);
}

/* -------------------------------------------------
   GAME CONTROL
---------------------------------------------------*/
window.startGame = function() {
    window.gameActive = true; 
    score = 0;
    gameSpeed = BASE_GAME_SPEED;
    currentLane = 1;

    foxPlayer.position.x = lanePositions[currentLane];

    obstacles.forEach(o => scene.remove(o));
    obstacles = [];

    scoreDisplay.textContent = "Score: 0";
    gameOverScreen.style.display = "none";
    gameOverScreen.style.opacity = 0;
    document.getElementById('leaderboard-screen').style.display = 'none'; 
    document.getElementById('initials-form').style.display = 'none'; // Reset form
    document.getElementById('user-id-display').textContent = window.qfoxUserId || 'Loading...';
    
    // Hide the start message when the game begins
    startMessage.classList.add('hidden');

    obstacleSpawnTimer = 0;
}

function moveFox(newLane) {
    if (!window.gameActive || newLane === currentLane || newLane < 0 || newLane > 2)
        return;

    currentLane = newLane;

    new TWEEN.Tween(foxPlayer.position)
        .to({ x: lanePositions[currentLane] }, 150)
        .easing(TWEEN.Easing.Quadratic.Out)
        .start();
}

function updateObstacles() {
    gameSpeed += SPEED_INCREASE_RATE;

    for (let i = obstacles.length - 1; i >= 0; i--) {
        const obs = obstacles[i];
        obs.position.z += gameSpeed;

        if (obs.position.z > 5 && obs.position.z < 6 && obs.userData.lane === currentLane) {
            gameOver();
            return;
        }

        if (obs.position.z > 10) {
            scene.remove(obs);
            obstacles.splice(i, 1);
            score += 10;
            scoreDisplay.textContent = "Score: " + score;
        }
    }

    obstacleSpawnTimer++;
    const spawnRate = Math.max(20, 60 - (gameSpeed - BASE_GAME_SPEED) * 100);

    if (obstacleSpawnTimer >= spawnRate) {
        createObstacle(Math.floor(Math.random() * 3));
        obstacleSpawnTimer = 0;
    }
}

function gameOver() {
    window.gameActive = false;
    
    // UI Updates
    document.getElementById("final-score").textContent = score;
    document.getElementById('user-id-display').textContent = window.qfoxUserId || 'Anonymous';
    gameOverScreen.style.display = "flex";
    
    // Trigger Score Logic
    if (typeof window.handleGameOver === 'function') {
        window.handleGameOver(score);
    }

    new TWEEN.Tween({ opacity: 0 })
        .to({ opacity: 1 }, 500)
        .onUpdate(o => {
            gameOverScreen.style.opacity = o.opacity;
        })
        .start();
}

/* -------------------------------------------------
   INPUT
---------------------------------------------------*/

function initialStartInput(e) {
    // Only proceed if the game is inactive AND no game over screen is showing 
    if (!window.gameActive && gameOverScreen.style.display !== 'flex' && 
        document.getElementById('leaderboard-screen').style.display !== 'flex') {
        
        if (e.type === 'touchstart' || e.code === "Space" || e.code === "KeyR" || 
            e.code === "ArrowLeft" || e.code === "ArrowRight" || e.code === "KeyA" || e.code === "KeyD") {
            
            if (e.type === 'touchstart') e.preventDefault();
            
            document.removeEventListener("keydown", initialStartInput);
            document.removeEventListener("touchstart", initialStartInput);
            
            window.startGame();
        }
    }
}

function onKeyDown(e) {
    const leaderboardScreen = document.getElementById('leaderboard-screen');
    const gameOverScreen = document.getElementById('game-over-screen');

    // Handle input when leaderboard is OPEN
    if (leaderboardScreen.style.display === 'flex') {
         if (e.code === "Escape" || e.code === "KeyL") { 
            leaderboardScreen.style.display = 'none';
        }
        return;
    }

    // Input inside inputs should not trigger game actions
    if (e.target.tagName === 'INPUT') return;

    // Handle input when game is INACTIVE (after game over)
    if (!window.gameActive && gameOverScreen.style.display === 'flex' && (e.code === "KeyR" || e.code === "Space")) {
        window.startGame();
        return;
    }

    // Handle input when game is ACTIVE
    if (window.gameActive) {
        if (e.code === "ArrowLeft" || e.code === "KeyA") moveFox(currentLane - 1);
        if (e.code === "ArrowRight" || e.code === "KeyD") moveFox(currentLane + 1);
    }
}

function onTouchStart(e) {
    if (e.touches.length > 0) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    }
}

function onTouchEnd(e) {
    const leaderboardScreen = document.getElementById('leaderboard-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    
    if (startMessage.style.display !== 'none' || leaderboardScreen.style.display === 'flex' || gameOverScreen.style.display === 'flex') {
        return;
    }

    if (e.changedTouches.length > 0) {
        const dx = e.changedTouches[0].clientX - touchStartX;
        const dy = e.changedTouches[0].clientY - touchStartY;

        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > SWIPE_THRESHOLD) {
            if (dx > 0) moveFox(currentLane + 1);
            else moveFox(currentLane - 1);
        }
    }
}

/* -------------------------------------------------
   MAIN
---------------------------------------------------*/
function init() {
    scene = new THREE.Scene();

    setupVideoBackground();

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(0, 3, 10);
    camera.lookAt(0, 1, 0);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 2));

    createFox();
    createTrack();

    window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
    document.addEventListener("keydown", onKeyDown);
    document.addEventListener("touchstart", onTouchStart);
    document.addEventListener("touchend", onTouchEnd);
    
    document.addEventListener("keydown", initialStartInput);
    document.addEventListener("touchstart", initialStartInput);

    // Initial state
    window.gameActive = false;
    gameOverScreen.style.display = 'none';
    startMessage.classList.remove('hidden');
}

function animate() {
    requestAnimationFrame(animate);
    TWEEN.update();

    if (window.gameActive) {
        updateObstacles();

        runningTime += 0.1;
        foxPlayer.position.y = FOX_BASE_HEIGHT + Math.sin(runningTime * 5) * 0.1;

        if (floorTexture)
            floorTexture.offset.y += gameSpeed * 0.05;
    }

    renderer.render(scene, camera);
}

window.onload = () => {
    initializeMusic();
    init();
    animate();
};
</script>

</body>
</html>