<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Quantum Fox: Endless Runner</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/23.1.1/tween.umd.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#0d1117; color:#f3f4f6; font-family:Inter,system-ui,Arial; }
    canvas { display:block; }
    #ui-container{
      position:absolute; top:0; left:0; right:0; padding:10px 20px; z-index:10;
      display:flex; justify-content:space-between; align-items:center; pointer-events:none;
    }
    .info-box{
      background: rgba(0,0,0,0.7); padding:8px 16px; border-radius:8px; font-size:1.1rem;
      font-weight:700; border:2px solid #3b82f6; min-width:140px; text-align:center;
    }
    #game-over-screen,#leaderboard-screen{
      position:absolute; inset:0; display:none; z-index:30; align-items:center;
      justify-content:center; background:rgba(0,0,0,0.9);
      flex-direction:column; opacity:0; transition:opacity .4s;
    }
  </style>
</head>

<body>
<div id="ui-container">
  <div id="score-display" class="info-box">Score: 0</div>
  <div id="high-score-display" class="info-box">High Score: 0</div>
  <div class="info-box">TAP LEFT / RIGHT</div>
</div>

<div id="game-container"></div>

<div id="game-over-screen">
  <h2 style="font-size:3rem;color:#ef4444;font-weight:900">STATE COLLAPSE</h2>
  <p>Final Score: <span id="final-score">0</span></p>

  <div id="initials-form" style="display:none">
    <input id="initials-input" maxlength="5"
           style="font-size:3rem;text-align:center;background:#000;color:#10b981;width:220px"/>
    <button id="submit-score-btn">SUBMIT</button>
  </div>

  <button id="restart-btn">RESTART</button>
  <button id="leaderboard-btn">LEADERBOARD</button>
</div>

<div id="leaderboard-screen">
  <button id="close-leaderboard">CLOSE</button>
  <div id="leaderboard-list">Loading...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyBgfoQLeOOqbKBuM69SO88jhCpfwrz_koo",
  authDomain:"qfox-29287.firebaseapp.com",
  projectId:"qfox-29287"
};

initializeApp(firebaseConfig);
const db = getFirestore();
signInAnonymously(getAuth());

// ASSETS
const FOX_HEAD_URL='head.png';
const OBSTACLE_URL='orb.png';
const HALO_URL='halo.png';
const FLOOR_IMAGE_URL='floor.png';

// GAME STATE
let scene,camera,renderer;
let fox,floorTex;
let obstacles=[];
let score=0;
let gameActive=false;
let gameSpeed=0.25;
const BASE_SPEED=0.25;
const container=document.getElementById('game-container');
const textureLoader=new THREE.TextureLoader();

const lanes=[-3.5,0,3.5];
let currentLane=1;

// TAP CONTROLS âœ…
function tapControl(e){
  const x=e.touches[0].clientX;
  if(!gameActive){ startGame(); return; }
  if(x < window.innerWidth/2) moveFox(currentLane-1);
  else moveFox(currentLane+1);
}
document.addEventListener('touchstart',tapControl,{passive:true});

// SETUP
function init(){
  scene=new THREE.Scene();
  scene.fog=new THREE.Fog(0x111827,40,150);

  camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1000);
  camera.position.set(0,3.5,10);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(devicePixelRatio);
  container.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0xffffff,20));

  createFox();
  createTrack();

  window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });
}

function createFox(){
  const g=new THREE.PlaneGeometry(1.8,1.8);
  const m=new THREE.MeshBasicMaterial({transparent:true});
  fox=new THREE.Mesh(g,m);
  textureLoader.load(FOX_HEAD_URL,t=>{
    t.encoding=THREE.sRGBEncoding;
    fox.material.map=t;
    fox.material.needsUpdate=true;
  });
  fox.position.set(lanes[currentLane],1.2,5);
  scene.add(fox);
}

function createTrack(){
  const g=new THREE.PlaneGeometry(18,600);
  floorTex=textureLoader.load(FLOOR_IMAGE_URL,t=>{
    t.wrapS=t.wrapT=THREE.RepeatWrapping;
    t.repeat.set(4,60);
  });
  const m=new THREE.MeshBasicMaterial({map:floorTex,side:THREE.DoubleSide});
  const floor=new THREE.Mesh(g,m);
  floor.rotation.x=-Math.PI/2;
  scene.add(floor);
}

function createObstacle(lane){
  const x=lanes[lane];

  const halo=new THREE.Mesh(
    new THREE.PlaneGeometry(2.6,2.6),
    new THREE.MeshBasicMaterial({
      transparent:true,
      depthWrite:false,
      depthTest:false,
      blending:THREE.AdditiveBlending
    })
  );
  textureLoader.load(HALO_URL,t=>{
    t.encoding=THREE.sRGBEncoding;
    halo.material.map=t;
  });

  const orb=new THREE.Mesh(
    new THREE.PlaneGeometry(1.8,1.8),
    new THREE.MeshBasicMaterial({transparent:true})
  );
  textureLoader.load(OBSTACLE_URL,t=>{
    t.encoding=THREE.sRGBEncoding;
    orb.material.map=t;
  });

  halo.position.set(x,1.35,-120);
  orb.position.set(x,1.35,-120);
  orb.userData={lane,halo};

  scene.add(halo);
  scene.add(orb);
  obstacles.push(orb);
}

function moveFox(lane){
  if(lane<0||lane>2) return;
  currentLane=lane;
  new TWEEN.Tween(fox.position).to({x:lanes[lane]},150).start();
}

function startGame(){
  gameActive=true;
  score=0;
  gameSpeed=BASE_SPEED;
  obstacles.forEach(o=>{
    scene.remove(o);
    if(o.userData.halo) scene.remove(o.userData.halo);
  });
  obstacles=[];
}

function update(){
  requestAnimationFrame(update);
  TWEEN.update();

  if(gameActive){
    gameSpeed+=0.0006;
    if(Math.random()<0.02) createObstacle(Math.floor(Math.random()*3));

    for(let i=obstacles.length-1;i>=0;i--){
      const o=obstacles[i];
      o.position.z+=gameSpeed;
      o.userData.halo.position.z=o.position.z-0.01;
      o.lookAt(camera.position);
      o.userData.halo.lookAt(camera.position);

      if(o.position.z>6 && o.userData.lane===currentLane){
        gameActive=false;
        document.getElementById('game-over-screen').style.display='flex';
      }
      if(o.position.z>100){
        scene.remove(o);
        scene.remove(o.userData.halo);
        obstacles.splice(i,1);
        score+=10;
        document.getElementById('score-display').textContent=`Score: ${score}`;
      }
    }
    floorTex.offset.y+=gameSpeed*0.02;
  }

  renderer.render(scene,camera);
}

init();
update();
</script>
</body>
</html>
